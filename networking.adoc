= Networking

toc::[]


## Configuring a custom PKI

[source,terminal]
----
$ oc create -f user-ca-bundle.yaml
----


[source,terminal]
----
$ oc edit proxy/cluster
----

## Configuring the node port service range

[source,terminal]
----
$ oc patch network.config.openshift.io cluster --type=merge -p \
  '{
    "spec":
      { "serviceNodePortRange": "30000-<port>" }
  }'
----

## Configuring PTP hardware

[source,terminal]
----
$ oc create -f <filename> 
----

## Configuring ExternalIPs for services

[source,terminal]
----
$ oc edit networks.config cluster
----

## Configuring ingress cluster traffic on AWS using a Network Load Balancer

[source,terminal]
----
$ oc create -f ingresscontroller-aws-nlb.yaml
----

## Configuring ingress cluster traffic using an Ingress Controller

[source,terminal]
----
$ oc new-project <project_name>
----


[source,terminal]
----
$ oc new-project myproject
----


[source,terminal]
----
$ oc new-app \
    -e MYSQL_USER=admin \
    -e MYSQL_PASSWORD=redhat \
    -e MYSQL_DATABASE=mysqldb \
    registry.redhat.io/rhscl/mysql-80-rhel7
----


[source,terminal]
----
$ oc expose service <service_name>
----


[source,terminal]
----
$ oc expose service mysql-80-rhel7
----

## Configuring ingress cluster traffic using a load balancer

[source,terminal]
----
$ oc new-project <project_name>
----


[source,terminal]
----
$ oc new-project myproject
----


[source,terminal]
----
$ oc new-app \
    -e MYSQL_USER=admin \
    -e MYSQL_PASSWORD=redhat \
    -e MYSQL_DATABASE=mysqldb \
    registry.redhat.io/rhscl/mysql-80-rhel7
----


[source,terminal]
----
$ oc expose service <service_name>
----


[source,terminal]
----
$ oc expose service mysql-80-rhel7
----


[source,terminal]
----
$ oc create -f <file-name>
----


[source,terminal]
----
$ oc create -f mysql-lb.yaml
----

## Configuring ingress cluster traffic using a NodePort

[source,terminal]
----
$ oc new-project <project_name>
----


[source,terminal]
----
$ oc new-project myproject
----


[source,terminal]
----
$ oc new-app \
    -e MYSQL_USER=admin \
    -e MYSQL_PASSWORD=redhat \
    -e MYSQL_DATABASE=mysqldb \
    registry.redhat.io/rhscl/mysql-80-rhel7
----


[source,terminal]
----
$ oc expose dc mysql-80-rhel7 --type=NodePort --name=mysql-ingress
----


[source,terminal]
----
$ oc delete svc mysql-80-rhel7
----

## Configuring ingress cluster traffic for a service external IP

[source,terminal]
----
$ oc patch svc <name> -p \
  '{
    "spec": {
      "externalIPs": [ "<ip_address>" ]
    }
  }'
----


[source,terminal]
----
$ oc patch svc mysql-55-rhel7 -p '{"spec":{"externalIPs":["192.174.120.10"]}}'
----

## DNS Operator in {product-title}

[source,terminal]
----
$ oc edit dns.operator/default
----

## Configuring the cluster-wide proxy

[source,terminal]
----
$ oc create -f user-ca-bundle.yaml
----


[source,terminal]
----
$ oc edit proxy/cluster
----


[source,terminal]
----
$ oc edit proxy/cluster
----

## Adding a pod to an SR-IOV additional network

[source,terminal]
----
$ oc create -f <name>.yaml
----


[source,terminal]
----
$ oc create -f <filename> 
----

## Configuring an SR-IOV network device

[source,terminal]
----
$ oc create -f <name>-sriov-node-network.yaml
----


[source,terminal]
----
$ oc create sriovnetwork.openshift.io cluster
----

## Configuring an SR-IOV InfiniBand network attachment

[source,terminal]
----
$ oc create -f <name>.yaml
----

## Configuring an SR-IOV Ethernet network attachment

[source,terminal]
----
$ oc create -f <name>.yaml
----

## Configuring the SR-IOV Network Operator

[source,terminal]
----
$ oc patch sriovoperatorconfig default \
  --type=merge -n openshift-sriov-network-operator \
  --patch '{ "spec": { "enableInjector": <value> } }'
----


[source,terminal]
----
$ oc patch sriovoperatorconfig default --type=merge \
  -n openshift-sriov-network-operator \
  --patch '{ "spec": { "enableOperatorWebhook": <value> } }'
----


[source,terminal]
----
$ oc patch sriovoperatorconfig default --type=json \
  -n openshift-sriov-network-operator \
  --patch '[{
      "op": "replace",
      "path": "/spec/configDaemonNodeSelector",
      "value": {<node-label>}
    }]'
----

## Using virtual functions (VFs) with DPDK and RDMA modes

[source,terminal]
----
$ oc create -f intel-dpdk-node-policy.yaml
----


[source,terminal]
----
$ oc create -f intel-dpdk-network.yaml
----


[source,terminal]
----
$ oc create -f intel-dpdk-pod.yaml
----


[source,terminal]
----
$ oc create -f mlx-dpdk-node-policy.yaml
----


[source,terminal]
----
$ oc create -f mlx-dpdk-network.yaml
----


[source,terminal]
----
$ oc create -f mlx-dpdk-pod.yaml
----


[source,terminal]
----
$ oc create -f mlx-rdma-node-policy.yaml
----


[source,terminal]
----
$ oc create -f mlx-rdma-network.yaml
----


[source,terminal]
----
$ oc create -f mlx-rdma-pod.yaml
----

## Ingress Operator in {product-title}

[source,terminal]
----
$ oc --namespace openshift-ingress create secret tls custom-certs-default --cert=tls.crt --key=tls.key
----


[source,terminal]
----
$ oc patch --type=merge --namespace openshift-ingress-operator ingresscontrollers/default \
  --patch '{"spec":{"defaultCertificate":{"name":"custom-certs-default"}}}'
----


[source,terminal]
----
$ oc patch -n openshift-ingress-operator ingresscontroller/default --patch '{"spec":{"replicas": 3}}' --type=merge
----


[source,terminal]
----
$ oc create -f <name>-ingress-controller.yaml 
----


[source,terminal]
----
$ oc replace --force --wait --filename - <<EOF
apiVersion: operator.openshift.io/v1
kind: IngressController
metadata:
  namespace: openshift-ingress-operator
  name: default
spec:
  endpointPublishingStrategy:
    type: LoadBalancerService
    loadBalancer:
      scope: Internal
EOF
----


[source,terminal]
----
$ oc -n openshift-ingress-operator patch ingresscontroller/default --patch '{"spec":{"routeAdmission":{"namespaceOwnership":"InterNamespaceAllowed"}}}' --type=merge
----


[source,terminal]
----
$ oc edit IngressController
----


[source,terminal]
----
$ oc edit IngressController
----


[source,terminal]
----
$ oc -n openshift-ingress-operator annotate ingresscontrollers/<ingresscontroller_name> ingress.operator.openshift.io/default-enable-http2=true
----


[source,terminal]
----
$ oc annotate ingresses.config/cluster ingress.operator.openshift.io/default-enable-http2=true
----


[source,terminal]
----
$ oc edit ingresses.config/cluster -o yaml
----


[source,terminal]
----
$ oc expose service hello-openshift
route.route.openshift.io/hello-openshift exposed
----

## Troubleshooting node network configuration

[source,terminal]
----
$ oc apply -f ens01-bridge-testfail.yaml
----


[source,terminal]
----
$ oc edit nncp ens01-bridge-testfail
----

## Updating node network configuration

[source,terminal]
----
$ oc apply -f <br1-eth1-policy.yaml> 
----


[source,terminal]
----
$ oc apply -f <br1-eth1-policy.yaml> 
----

## Load balancing on RHOSP

[source,terminal]
----
$ oc -n openshift-kuryr edit cm kuryr-config
----


[source,terminal]
----
$ oc -n openshift-kuryr edit cm kuryr-config
----


[source,terminal]
----
$ oc apply -f external_router.yaml
----

## Assigning a secondary network to a VRF

[source,terminal]
----
$ oc edit networks.operator.openshift.io cluster
----

## Attaching a pod to an additional network

[source,terminal]
----
$ oc create -f <name>.yaml
----


[source,terminal]
----
$ oc edit pod <name>
----


[source,terminal]
----
$ oc edit networks.operator.openshift.io cluster
----


[source,terminal]
----
$ oc edit pod <name>
----

## Configuring a bridge network

[source,terminal]
----
$ oc edit networks.operator.openshift.io cluster
----

## Configuring a host-device network

[source,terminal]
----
$ oc edit networks.operator.openshift.io cluster
----

## Configuring an ipvlan network

[source,terminal]
----
$ oc edit networks.operator.openshift.io cluster
----

## Configuring a macvlan network with basic customizations

[source,terminal]
----
$ oc edit networks.operator.openshift.io cluster
----

## Configuring a macvlan network

[source,terminal]
----
$ oc edit networks.operator.openshift.io cluster
----

## Editing an additional network

[source,terminal]
----
$ oc edit networks.operator.openshift.io cluster
----

## Removing an additional network

[source,terminal]
----
$ oc edit networks.operator.openshift.io cluster
----

## Removing a pod from an additional network

[source,terminal]
----
$ oc delete pod <name> -n <namespace>
----

## Understanding multiple networks

[source,terminal]
----
$ oc delete pod <name> -n <namespace>
----

## Creating a network policy

[source,terminal]
----
$ oc create -f <policy-name>.yaml -n <project>
----

## Creating default network policies for a new project

[source,terminal]
----
$ oc adm create-bootstrap-project-template -o yaml > template.yaml
----


[source,terminal]
----
$ oc create -f template.yaml -n openshift-config
----


[source,terminal]
----
$ oc edit template <project_template> -n openshift-config
----


[source,terminal]
----
$ oc new-project <project> 
----

## Deleting a network policy

[source,terminal]
----
$ oc delete networkpolicy <policy-name>
----

## Editing a network policy

[source,terminal]
----
$ oc apply -f <policy-file>.yaml
----


[source,terminal]
----
$ oc edit <policy-name> -n <namespace>
----

## Configuring egress IPs for a project

[source,terminal]
----
 $ oc patch netnamespace <project_name> --type=merge -p \ 
  '{
    "egressIPs": [
      "<ip_address>" 
    ]
  }'
----


[source,terminal]
----
$ oc patch hostsubnet <node_name> --type=merge -p \ 
  '{
    "egressCIDRs": [
      "<ip_address_range_1>", "<ip_address_range_2>" 
    ]
  }'
----


[source,terminal]
----
$ oc patch hostsubnet node1 --type=merge -p \
  '{"egressCIDRs": ["192.168.1.0/24"]}'
$ oc patch hostsubnet node2 --type=merge -p \
  '{"egressCIDRs": ["192.168.1.0/24"]}'
----


[source,terminal]
----
$ oc patch netnamespace <project> --type=merge -p \ 
  '{
    "egressIPs": [ 
      "<ip_address>"
      ]
  }'
----


[source,terminal]
----
$ oc patch hostsubnet <node_name> --type=merge -p \ 
  '{
    "egressIPs": [ 
      "<ip_address_1>",
      "<ip_address_N>"
      ]
  }'
----


[source,terminal]
----
$ oc patch hostsubnet node1 --type=merge -p \
  '{"egressIPs": ["192.168.1.100", "192.168.1.101", "192.168.1.102"]}'
----

## Configuring an egress firewall for a project

[source,terminal]
----
$ oc create -f <policy_name>.yaml -n <project>
----

## Configuring an egress router pod destination list from a config map

[source,terminal]
----
$ oc delete configmap egress-routes --ignore-not-found
----


[source,terminal]
----
$ oc create configmap egress-routes \
  --from-file=destination=my-egress-destination.txt
----

## Configuring kube-proxy

[source,terminal]
----
$ oc edit network.operator.openshift.io cluster
----

## Deploying an egress router pod in DNS proxy mode

[source,terminal]
----
$ oc create -f egress-router-service.yaml
----

## Disabling multicast for a project

[source,terminal]
----
$ oc annotate netnamespace <namespace> \ 
    netnamespace.network.openshift.io/multicast-enabled-
----

## Editing an egress firewall for a project

[source,terminal]
----
$ oc replace -f <filename>.yaml
----

## Enabling multicast for a project

[source,terminal]
----
$ oc annotate netnamespace <namespace> \
    netnamespace.network.openshift.io/multicast-enabled=true
----

## Configuring network isolation using OpenShift SDN

[source,terminal]
----
$ oc adm pod-network join-projects --to=<project1> <project2> <project3>
----


[source,terminal]
----
$ oc adm pod-network isolate-projects <project1> <project2>
----


[source,terminal]
----
$ oc adm pod-network make-projects-global <project1> <project2>
----

## Removing an egress firewall from a project

[source,terminal]
----
$ oc delete -n <project> egressnetworkpolicy <name>
----

## Assigning an egress IP address

[source,terminal]
----
$ oc apply -f <egressips_name>.yaml 
----

## Configuring an egress firewall for a project

[source,terminal]
----
$ oc create -f <policy_name>.yaml -n <project>
----

## Configuring an egress IP address

[source,terminal]
----
$ oc label nodes <node_name> k8s.ovn.org/egress-assignable="" 
----

## Disabling multicast for a project

[source,terminal]
----
$ oc annotate namespace <namespace> \ 
    k8s.ovn.org/multicast-enabled-
----

## Editing an egress firewall for a project

[source,terminal]
----
$ oc replace -f <filename>.yaml
----

## Enabling multicast for a project

[source,terminal]
----
$ oc annotate namespace <namespace> \
    k8s.ovn.org/multicast-enabled=true
----

## Migrate from the OpenShift SDN cluster network provider

[source,terminal]
----
$ oc annotate Network.operator.openshift.io cluster \
  'networkoperator.openshift.io/network-migration'=""
----


[source,terminal]
----
$ oc patch MachineConfigPool master --type='merge' --patch \
  '{ "spec": { "paused": true } }'
----


[source,terminal]
----
$ oc patch MachineConfigPool worker --type='merge' --patch \
  '{ "spec":{ "paused" :true } }'
----


[source,terminal]
----
$ oc patch Network.config.openshift.io cluster \
  --type='merge' --patch '{ "spec": { "networkType": "OVNKubernetes" } }'
----


[source,terminal]
----
$ oc patch Network.config.openshift.io cluster \
  --type='merge' --patch '{
    "spec": {
      "clusterNetwork": [
        "cidr": "<cidr>",
        "hostPrefix": "<prefix>"
      ]
      "networkType": "OVNKubernetes"
    }
  }'
----


[source,terminal]
----
$ oc patch Network.operator.openshift.io cluster --type=merge \
  --patch '{
    "spec":{
      "defaultNetwork":{
        "ovnKubernetesConfig":{
          "mtu":<mtu>,
          "genevePort":<port>
    }}}}'
----


[source,terminal]
----
$ oc patch Network.operator.openshift.io cluster --type=merge \
  --patch '{
    "spec":{
      "defaultNetwork":{
        "ovnKubernetesConfig":{
          "mtu":1200
    }}}}'
----


[source,terminal]
----
$ oc patch MachineConfigPool master --type='merge' --patch \
  '{ "spec": { "paused": false } }'
----


[source,terminal]
----
$ oc patch MachineConfigPool worker --type='merge' --patch \
  '{ "spec": { "paused": false } }'
----


[source,terminal]
----
$ oc annotate Network.operator.openshift.io cluster \
  networkoperator.openshift.io/network-migration-
----


[source,terminal]
----
$ oc delete namespace openshift-sdn
----

## Removing an egress firewall from a project

[source,terminal]
----
$ oc delete -n <project> egressfirewall <name>
----

## Rollback to the OpenShift SDN network provider

[source,terminal]
----
$ oc annotate Network.operator.openshift.io cluster \
  'networkoperator.openshift.io/network-migration'=""
----


[source,terminal]
----
$ oc patch MachineConfigPool master --type='merge' --patch \
  '{ "spec": { "paused": true } }'
----


[source,terminal]
----
$ oc patch MachineConfigPool worker --type='merge' --patch \
  '{ "spec":{ "paused" :true } }'
----


[source,terminal]
----
$ oc patch Network.config.openshift.io cluster \
  --type='merge' --patch '{ "spec": { "networkType": "OpenShiftSDN" } }'
----


[source,terminal]
----
$ oc patch Network.operator.openshift.io cluster --type=merge \
  --patch '{
    "spec":{
      "defaultNetwork":{
        "openshiftSDNConfig":{
          "mtu":<mtu>,
          "vxlanPort":<port>
    }}}}'
----


[source,terminal]
----
$ oc patch Network.operator.openshift.io cluster --type=merge \
  --patch '{
    "spec":{
      "defaultNetwork":{
        "openshiftSDNConfig":{
          "mtu":1200
    }}}}'
----


[source,terminal]
----
$ oc patch MachineConfigPool master --type='merge' --patch \
  '{ "spec": { "paused": false } }'
----


[source,terminal]
----
$ oc patch MachineConfigPool worker --type='merge' --patch \
  '{ "spec": { "paused": false } }'
----


[source,terminal]
----
$ oc annotate Network.operator.openshift.io cluster \
  networkoperator.openshift.io/network-migration-
----


[source,terminal]
----
$ oc delete namespace openshift-ovn-kubernetes
----

## Route configuration

[source,terminal]
----
$ oc annotate route <route_name> \
    --overwrite haproxy.router.openshift.io/timeout=<timeout><time_unit> 
----


[source,terminal]
----
$ oc annotate route myroute --overwrite haproxy.router.openshift.io/timeout=2s
----


[source,terminal]
----
$ oc annotate route <route_name> router.openshift.io/<cookie_name>="-<cookie_annotation>"
----


[source,terminal]
----
$ oc annotate route my_route router.openshift.io/my_cookie="-my_cookie_annotation"
----


[source,terminal]
----
$ oc -n openshift-ingress-operator patch ingresscontroller/default --patch '{"spec":{"routeAdmission":{"namespaceOwnership":"InterNamespaceAllowed"}}}' --type=merge
----


[source,terminal]
----
$ oc apply -f ingress.yaml
----

## Secured routes

[source,terminal]
----
$ oc create route reencrypt --service=frontend --cert=tls.crt --key=tls.key --dest-ca-cert=destca.crt --ca-cert=ca.crt --hostname=www.example.com
----


[source,terminal]
----
$ oc create route edge --service=frontend --cert=tls.crt --key=tls.key --ca-cert=ca.crt --hostname=www.example.com
----


[source,terminal]
----
$ oc create route passthrough route-passthrough-secured --service=frontend --port=8080
----

## Using cookies to keep route statefulness

[source,terminal]
----
$ oc annotate route <route_name> router.openshift.io/<cookie_name>="-<cookie_annotation>"
----


[source,terminal]
----
$ oc annotate route my_route router.openshift.io/my_cookie="-my_cookie_anno"
----

## Using the Stream Control Transmission Protocol (SCTP) on a bare metal cluster

[source,terminal]
----
$ oc create -f load-sctp-module.yaml
----


[source,terminal]
----
$ oc create -f sctp-server.yaml
----


[source,terminal]
----
$ oc create -f sctp-service.yaml
----


[source,terminal]
----
$ oc apply -f sctp-client.yaml
----
